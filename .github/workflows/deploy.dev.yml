name: Deploy BiuBiu.Tools EXE (Develop)

on:
  push:
    branches:
      - develop
  workflow_dispatch:
    inputs:
      rollback_to:
        description: 'Release name to rollback to (leave empty for normal deploy)'
        required: false
        default: ''

# Prevent concurrent deployments
concurrency:
  group: deploy-dev
  cancel-in-progress: false

jobs:
  deploy-dev:
    runs-on: ubuntu-latest
    env:
      PROJECT_NAME: 'BiuBiu.Tools (Develop)'
      SSH_HOST: ${{ secrets.DEV_SSH_HOST }}
      SSH_USER: ${{ secrets.DEV_SSH_USER }}
      SSH_KEY:  ${{ secrets.DEV_SSH_KEY }}
      EXE_NAME: 'biubiu'
      BASE_PATH: '/opt/biubiu.tools/develop'
      SERVICE_NAME: 'biubiu-develop.service'
      SOURCE_PATH: "apps/biubiu.tools/dist/biubiu"
      ENV_CONTENT: ${{ secrets.DEV_ENV_FILE }}
      KEEP_RELEASES: 10
    steps:
      - name: Checkout code
        if: ${{ github.event.inputs.rollback_to == '' }}
        uses: actions/checkout@v4

      - name: Setup Bun
        if: ${{ github.event.inputs.rollback_to == '' }}
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: 1.3.8

      - name: Cache bun dependencies
        if: ${{ github.event.inputs.rollback_to == '' }}
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: ${{ runner.os }}-bun-

      - name: Install & Build
        if: ${{ github.event.inputs.rollback_to == '' }}
        run: |
          bun install
          bun run build:${{ env.EXE_NAME }}

      - name: Verify build output
        if: ${{ github.event.inputs.rollback_to == '' }}
        run: |
          if [ ! -f "${{ env.SOURCE_PATH }}" ]; then
            echo "::error::Build failed: executable not found at ${{ env.SOURCE_PATH }}"
            exit 1
          fi
          echo "Build successful"
          echo "  Size: $(du -h ${{ env.SOURCE_PATH }} | cut -f1)"
          echo "  SHA256: $(sha256sum ${{ env.SOURCE_PATH }} | cut -d' ' -f1)"

      - name: Prepare Release Info
        id: release_info
        run: |
          if [ -n "${{ github.event.inputs.rollback_to }}" ]; then
            echo "release_name=${{ github.event.inputs.rollback_to }}" >> $GITHUB_OUTPUT
            echo "is_rollback=true" >> $GITHUB_OUTPUT
            echo "ğŸ”„ Rollback to: ${{ github.event.inputs.rollback_to }}"
          else
            RELEASE_NAME="$(date +%Y%m%d-%H%M%S)-$(git rev-parse --short HEAD)"
            echo "release_name=$RELEASE_NAME" >> $GITHUB_OUTPUT
            echo "is_rollback=false" >> $GITHUB_OUTPUT
            echo "ğŸ“¦ New Release: $RELEASE_NAME"
          fi

      - name: Setup Directory Structure (First Deploy Only)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          key: ${{ env.SSH_KEY }}
          script: |
            # Only create if directory doesn't exist
            if [ ! -d "${{ env.BASE_PATH }}/releases" ]; then
              echo "First deploy, creating directory structure..."
              sudo mkdir -p ${{ env.BASE_PATH }}/releases
              sudo mkdir -p ${{ env.BASE_PATH }}/logs
              sudo chown -R ${{ env.SSH_USER }}:${{ env.SSH_USER }} ${{ env.BASE_PATH }}
            else
              echo "Directory structure exists, skipping"
            fi

      - name: Setup Systemd Service (First Deploy Only)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          key: ${{ env.SSH_KEY }}
          script: |
            # Only create if service file doesn't exist
            if [ ! -f "/etc/systemd/system/${{ env.SERVICE_NAME }}" ]; then
              echo "First deploy, creating systemd service..."
              sudo tee /etc/systemd/system/${{ env.SERVICE_NAME }} > /dev/null << 'EOF'
            [Unit]
            Description=BiuBiu.Tools Develop Service
            After=network.target

            [Service]
            ExecStart=${{ env.BASE_PATH }}/current/${{ env.EXE_NAME }}
            WorkingDirectory=${{ env.BASE_PATH }}/current
            Restart=always
            User=${{ env.SSH_USER }}
            EnvironmentFile=${{ env.BASE_PATH }}/current/.env
            StandardOutput=append:${{ env.BASE_PATH }}/logs/app.log
            StandardError=append:${{ env.BASE_PATH }}/logs/error.log

            [Install]
            WantedBy=multi-user.target
            EOF
              sudo systemctl daemon-reload
              sudo systemctl enable ${{ env.SERVICE_NAME }}
            else
              echo "Systemd service exists, skipping"
            fi

      - name: Create Release Directory
        if: ${{ steps.release_info.outputs.is_rollback == 'false' }}
        uses: appleboy/ssh-action@v1.0.3
        env:
          RELEASE_NAME: ${{ steps.release_info.outputs.release_name }}
        with:
          host: ${{ env.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          key: ${{ env.SSH_KEY }}
          envs: RELEASE_NAME
          script: |
            mkdir -p ${{ env.BASE_PATH }}/releases/$RELEASE_NAME
            echo "ğŸ“ Created release directory: $RELEASE_NAME"

      - name: Copy Binary to Server (SCP)
        if: ${{ steps.release_info.outputs.is_rollback == 'false' }}
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ env.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          key: ${{ env.SSH_KEY }}
          source: ${{ env.SOURCE_PATH }}
          target: ${{ env.BASE_PATH }}/releases/${{ steps.release_info.outputs.release_name }}
          strip_components: 3

      - name: Deploy & Activate Release
        id: deploy
        uses: appleboy/ssh-action@v1.0.3
        env:
          RELEASE_NAME: ${{ steps.release_info.outputs.release_name }}
          ENV_CONTENT: ${{ env.ENV_CONTENT }}
          IS_ROLLBACK: ${{ steps.release_info.outputs.is_rollback }}
        with:
          host: ${{ env.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          key: ${{ env.SSH_KEY }}
          envs: RELEASE_NAME,ENV_CONTENT,IS_ROLLBACK
          script: |
            RELEASE_PATH="${{ env.BASE_PATH }}/releases/$RELEASE_NAME"
            CURRENT_LINK="${{ env.BASE_PATH }}/current"

            # Verify release exists (for rollback)
            if [ ! -d "$RELEASE_PATH" ]; then
              echo "::error::Release not found: $RELEASE_NAME"
              exit 1
            fi

            # Record current version for rollback
            PREVIOUS_RELEASE=""
            if [ -L "$CURRENT_LINK" ]; then
              PREVIOUS_RELEASE=$(readlink -f "$CURRENT_LINK")
              echo "Current version: $(basename $PREVIOUS_RELEASE)"
            fi

            # Write env vars to release directory (skip if rollback and .env exists)
            if [ "$IS_ROLLBACK" = "false" ] || [ ! -f "$RELEASE_PATH/.env" ]; then
              echo "$ENV_CONTENT" > "$RELEASE_PATH/.env"
              echo ".env file written"
            fi

            # Set executable permission
            chmod +x "$RELEASE_PATH/${{ env.EXE_NAME }}"

            # Update symlink to new release
            ln -sfn "$RELEASE_PATH" "$CURRENT_LINK"
            echo "Symlink updated -> $RELEASE_NAME"

            # Restart service
            sudo systemctl restart ${{ env.SERVICE_NAME }}

            # HTTP Health check with retry
            echo "Performing health check..."
            # Read PORT from .env file
            APP_PORT=$(grep -E "^PORT=" "$RELEASE_PATH/.env" | cut -d'=' -f2 | tr -d '"' | tr -d "'")
            APP_PORT=${APP_PORT:-3000}  # Default to 3000 if not set
            echo "Using port: $APP_PORT"

            HEALTH_OK=false
            for i in $(seq 1 30); do
              if curl -sf "http://localhost:$APP_PORT/" > /dev/null 2>&1; then
                echo "âœ… Health check passed (attempt $i)"
                HEALTH_OK=true
                break
              fi
              echo "  Waiting... ($i/30)"
              sleep 1
            done

            if [ "$HEALTH_OK" = "false" ]; then
              echo "âŒ Health check failed after 30 seconds"

              # Show recent logs for debugging
              echo "=== Recent Logs ==="
              tail -20 ${{ env.BASE_PATH }}/logs/error.log 2>/dev/null || true

              # Rollback to previous version
              if [ -n "$PREVIOUS_RELEASE" ] && [ -d "$PREVIOUS_RELEASE" ]; then
                echo "Rolling back to: $(basename $PREVIOUS_RELEASE)"
                ln -sfn "$PREVIOUS_RELEASE" "$CURRENT_LINK"
                sudo systemctl restart ${{ env.SERVICE_NAME }}
                echo "Rolled back successfully"
              fi
              exit 1
            fi

      - name: Cleanup Old Releases
        if: ${{ steps.release_info.outputs.is_rollback == 'false' }}
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          key: ${{ env.SSH_KEY }}
          script: |
            RELEASES_DIR="${{ env.BASE_PATH }}/releases"
            KEEP=${{ env.KEEP_RELEASES }}

            # Get all release directories, sort by time, keep latest N
            cd "$RELEASES_DIR"
            RELEASE_COUNT=$(ls -1d */ 2>/dev/null | wc -l)

            if [ "$RELEASE_COUNT" -gt "$KEEP" ]; then
              echo "Cleaning old releases (keeping latest $KEEP)..."
              ls -1dt */ | tail -n +$((KEEP + 1)) | while read dir; do
                echo "  Deleting: $dir"
                rm -rf "$dir"
              done
            else
              echo "Current $RELEASE_COUNT releases, no cleanup needed"
            fi

            # Show currently retained releases
            echo "Current releases:"
            ls -1dt */ | head -n $KEEP

      - name: Notify Success
        if: success()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ "${{ steps.release_info.outputs.is_rollback }}" = "true" ]; then
            MESSAGE="ğŸ”„ *Rollback Successful*%0A%0AğŸ“¦ *Project:* ${{ env.PROJECT_NAME }}%0AğŸ· *Release:* \`${{ steps.release_info.outputs.release_name }}\`%0AğŸ‘¤ *Triggered by:* ${{ github.actor }}%0AğŸ”— *Repo:* [${{ github.repository }}](${{ github.server_url }}/${{ github.repository }})"
          else
            MESSAGE="âœ… *Deploy Successful*%0A%0AğŸ“¦ *Project:* ${{ env.PROJECT_NAME }}%0AğŸ· *Release:* \`${{ steps.release_info.outputs.release_name }}\`%0AğŸ“ *Commit:* [\`${GITHUB_SHA::7}\`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})%0AğŸ‘¤ *Triggered by:* ${{ github.actor }}%0AğŸ”— *Repo:* [${{ github.repository }}](${{ github.server_url }}/${{ github.repository }})"
          fi
          curl -sf -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_CHAT_ID}" \
            -d "text=${MESSAGE}" \
            -d "parse_mode=Markdown" \
            -d "disable_web_page_preview=true" || true

      - name: Notify Failure
        if: failure()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          MESSAGE="âŒ *Deploy Failed*%0A%0AğŸ“¦ *Project:* ${{ env.PROJECT_NAME }}%0AğŸ“ *Commit:* [\`${GITHUB_SHA::7}\`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})%0AğŸ‘¤ *Triggered by:* ${{ github.actor }}%0AğŸ”— *Repo:* [${{ github.repository }}](${{ github.server_url }}/${{ github.repository }})%0AğŸ” *Workflow:* [View Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
          curl -sf -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_CHAT_ID}" \
            -d "text=${MESSAGE}" \
            -d "parse_mode=Markdown" \
            -d "disable_web_page_preview=true" || true
