name: Publish Packages to npm

on:
  push:
    branches:
      - main
    paths:
      - 'packages/**'

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Setup npm auth
        run: echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" > ~/.npmrc

      - name: Build and publish packages
        run: |
          publish_if_needed() {
            local pkg_dir=$1
            local pkg_name=$(jq -r '.name' "$pkg_dir/package.json")
            local local_version=$(jq -r '.version' "$pkg_dir/package.json")

            # Get npm version (returns empty if package doesn't exist)
            npm_version=$(npm view "$pkg_name" version 2>/dev/null || echo "")

            echo "üì¶ $pkg_name"
            echo "   Local:  $local_version"
            echo "   npm:    ${npm_version:-not published}"

            if [ "$local_version" != "$npm_version" ]; then
              echo "   ‚û°Ô∏è  Publishing..."
              cd "$pkg_dir"
              bun run build
              npm publish --access public
              cd - > /dev/null
              echo "   ‚úÖ Published $pkg_name@$local_version"
            else
              echo "   ‚è≠Ô∏è  Skipped (version unchanged)"
            fi
            echo ""
          }

          for dir in packages/*/; do
            if [ -f "$dir/package.json" ]; then
              publish_if_needed "$dir"
            fi
          done
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
